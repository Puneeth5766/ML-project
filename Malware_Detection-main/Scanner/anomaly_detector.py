import math
from collections import Counter
import os


def calculate_entropy(data):
    counts = Counter(data)
    entropy = 0.0
    total = len(data)

    if total == 0:
        return 0.0

    for count in counts.values():
        p = count / total
        entropy -= p * math.log2(p)

    return entropy


def byte_distribution_score(data):
    """
    Detect if distribution is extremely uneven or extremely uniform.
    Both can be suspicious.
    """
    counts = Counter(data)
    total = len(data)

    if total == 0:
        return 0

    unique_bytes = len(counts)

    # Too few unique bytes → suspicious (possibly encoded blob)
    if unique_bytes < 20:
        return 20

    # Too many evenly distributed bytes → possible packed file
    if unique_bytes > 200:
        return 15

    return 0


def size_anomaly_score(file_path):
    size = os.path.getsize(file_path)

    # Extremely small executable-like binary
    if size < 100:  
        return 10

    # Extremely large unknown file
    if size > 50 * 1024 * 1024:  # 50 MB
        return 15

    return 0


def scan_unknown(file_path):
    try:
        with open(file_path, "rb") as f:
            data = f.read()
    except:
        return {"type": "unknown", "error": True}

    entropy = calculate_entropy(data)
    dist_score = byte_distribution_score(data)
    size_score = size_anomaly_score(file_path)

    score = 0
    signals = []

    # Entropy analysis
    if entropy > 7.8:
        score += 30
        signals.append("Very high entropy (packed/encrypted)")
    elif entropy > 7.2:
        score += 15
        signals.append("High entropy")

    # Distribution anomaly
    if dist_score > 0:
        score += dist_score
        signals.append("Byte distribution anomaly")

    # Size anomaly
    if size_score > 0:
        score += size_score
        signals.append("Unusual file size")

    return {
        "type": "unknown",
        "anomaly_score": score,
        "entropy": entropy,
        "signals": signals
    }
