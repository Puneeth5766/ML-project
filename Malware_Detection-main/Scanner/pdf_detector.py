import math
from collections import Counter


PDF_STRUCTURAL_INDICATORS = {
    b"/JavaScript": 40,
    b"/OpenAction": 30,
    b"/Launch": 40,
    b"/EmbeddedFile": 30
}


def calculate_entropy(data):
    counts = Counter(data)
    entropy = 0.0
    total = len(data)

    for c in counts.values():
        p = c / total
        entropy -= p * math.log2(p)

    return entropy


def scan_pdf(file_path):
    try:
        with open(file_path, "rb") as f:
            data = f.read()
    except:
        return {"type": "pdf", "error": True}

    score = 0
    signals = []

    for indicator, weight in PDF_STRUCTURAL_INDICATORS.items():
        if indicator in data:
            score += weight
            signals.append(indicator.decode())

    entropy = calculate_entropy(data)

    # High entropy stream = suspicious packing
    if entropy > 7.5:
        score += 20
        signals.append("High entropy")

    return {
        "type": "pdf",
        "structure_score": score,
        "entropy": entropy,
        "signals": signals
    }
