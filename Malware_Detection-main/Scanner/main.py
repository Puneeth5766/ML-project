import os
import sys

from script_detector import scan_script
from pdf_detector import scan_pdf
from anomaly_detector import scan_unknown
from risk_engine import fuse_risk
# from pe_detector import scan_pe   # Uncomment when connecting ML


def route_file(file_path):
    ext = os.path.splitext(file_path)[1].lower()

    if ext in [".py", ".js", ".ps1", ".bat"]:
        raw_result = scan_script(file_path)

    elif ext == ".pdf":
        raw_result = scan_pdf(file_path)

    elif ext in [".exe", ".dll"]:
        return {"verdict": "PE DETECTOR NOT CONNECTED", "score": 0}

    else:
        raw_result = scan_unknown(file_path)

    return fuse_risk(raw_result)


if __name__ == "__main__":

    if len(sys.argv) < 2:
        print("Usage: python main.py <file_path>")
        sys.exit(1)

    file_path = sys.argv[1]

    if not os.path.exists(file_path):
        print("File does not exist.")
        sys.exit(1)

    result = route_file(file_path)

    print("\n========= SCAN RESULT =========")
    print("Verdict:", result["verdict"])
    print("Risk Score:", result["score"])

    if "reasons" in result:
        print("Reasons:")
        for r in result["reasons"]:
            print(" -", r)
