import sys
import os
import joblib
import pefile
import math
from collections import Counter
import numpy as np

from Scanner.script_detector import scan_script
from Scanner.pdf_detector import scan_pdf
from Scanner.anomaly_detector import scan_unknown
from Scanner.risk_engine import fuse_risk

print(" malware_scanner.py started")


# ================= PE FEATURE EXTRACTION (Memory Safe) =================

def extract_features_from_exe(file_path, model):

    byte_counts = Counter()
    total = 0
    chunk_size = 1024 * 1024  # 1MB chunks (safe for large files)

    try:
        with open(file_path, "rb") as f:
            while True:
                chunk = f.read(chunk_size)
                if not chunk:
                    break
                byte_counts.update(chunk)
                total += len(chunk)
    except:
        return None

    if total == 0:
        return None

    # Byte histogram
    histogram = [byte_counts.get(i, 0) for i in range(256)]

    # Entropy
    entropy = 0.0
    for c in byte_counts.values():
        p = c / total
        entropy -= p * math.log2(p)

    size = total

    # PE-specific metadata
    try:
        pe = pefile.PE(file_path, fast_load=True)
        num_sections = len(pe.sections)
        num_imports = sum(len(e.imports) for e in pe.DIRECTORY_ENTRY_IMPORT) \
            if hasattr(pe, "DIRECTORY_ENTRY_IMPORT") else 0
        num_exports = len(pe.DIRECTORY_ENTRY_EXPORT.symbols) \
            if hasattr(pe, "DIRECTORY_ENTRY_EXPORT") else 0
        has_resources = int(hasattr(pe, "DIRECTORY_ENTRY_RESOURCE"))
        has_debug = int(hasattr(pe, "DIRECTORY_ENTRY_DEBUG"))
        pe.close()
    except:
        num_sections = num_imports = num_exports = has_resources = has_debug = 0

    features = histogram + [
        entropy, size,
        num_sections, num_imports, num_exports,
        has_resources, has_debug
    ]

    features = np.array(features, dtype=np.float32)

    # Match model feature size
    if features.shape[0] < model.n_features_in_:
        features = np.pad(features, (0, model.n_features_in_ - features.shape[0]))
    else:
        features = features[:model.n_features_in_]

    return features.reshape(1, -1)


# ================= FILE SCANNER =================

def scan_file(file_path, model):

    print("\n Scanning:", file_path)
    ext = os.path.splitext(file_path)[1].lower()

    try:

        # -------- PE FILE (ML) --------
        if ext in [".exe", ".dll"]:

            features = extract_features_from_exe(file_path, model)
            if features is None:
                print(" Could not extract features")
                return "SAFE"

            pred = model.predict(features)[0]
            prob = model.predict_proba(features)[0][1]

            raw_result = {
                "type": "pe",
                "ml_score": int(prob * 100),
                "signals": ["RandomForest ML classification"]
            }

        # -------- SCRIPT FILE --------
        elif ext in [".py", ".js", ".ps1", ".bat"]:
            raw_result = scan_script(file_path)

        # -------- PDF FILE --------
        elif ext == ".pdf":
            raw_result = scan_pdf(file_path)

        # -------- UNKNOWN FILE --------
        else:
            raw_result = scan_unknown(file_path)

        # -------- FUSE RISK --------
        final_result = fuse_risk(raw_result)

        print("Verdict:", final_result["verdict"])
        print("Score:", final_result["score"])

        if final_result["verdict"] == "MALWARE":
            return "MALWARE"
        else:
            return "SAFE"

    except Exception as e:
        print(" Scan error:", e)
        return "SAFE"


# ================= PATH SCANNER =================

def scan_path(path, model):

    overall_safe = True

    if os.path.isfile(path):

        result = scan_file(path, model)
        if result == "MALWARE":
            overall_safe = False

    elif os.path.isdir(path):

        print(" Scanning folder:", path)

        for root, _, files in os.walk(path):
            for f in files:
                full_path = os.path.join(root, f)
                result = scan_file(full_path, model)
                if result == "MALWARE":
                    overall_safe = False

    else:
        print(" Invalid path")
        return

    # -------- FINAL VERDICT --------

    print("\n========= FINAL VERDICT =========")

    if overall_safe:
        print(" ALL FILES SAFE")
        print(" Proceed with compression / encryption")
    else:
        print(" MALWARE FOUND")
        print(" Transfer blocked")


# ================= ENTRY POINT =================

if __name__ == "__main__":

    if len(sys.argv) < 2:
        print("Usage: python malware_scanner.py <file_or_folder_path>")
        sys.exit(1)

    print(" Loading model...")
    model = joblib.load("rf_ember.pkl")
    print(" Model loaded")

    scan_path(sys.argv[1], model)
